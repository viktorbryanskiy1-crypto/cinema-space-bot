<!-- templates/admin/add_video.html -->
{% extends "admin/base.html" %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>üé¨ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ</h2>
    <p class="text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ</p>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å–ø–æ—Å–æ–±–∞–º–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <ul class="nav nav-tabs mb-4" id="addVideoTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="direct-tab" data-bs-toggle="tab" data-bs-target="#direct" type="button" role="tab">
                üöÄ –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="link-tab" data-bs-toggle="tab" data-bs-target="#link" type="button" role="tab">
                üîó –ü–æ —Å—Å—ã–ª–∫–µ
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="addVideoTabContent">
        <!-- –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ -->
        <div class="tab-pane fade show active" id="direct" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üöÄ –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</h5>
                    <p class="card-text text-muted">
                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é. –û–Ω–æ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ –≤–∞—à Telegram –∫–∞–Ω–∞–ª –∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
                    </p>
                    
                    <form id="direct-upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="video_file" class="form-label">–í–∏–¥–µ–æ—Ñ–∞–π–ª *</label>
                            <input type="file" class="form-control" id="video_file" name="video_file" accept="video/*" required>
                            <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, WMV, FLV, WEBM, MKV. –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä: 50MB</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="direct_title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" class="form-control" id="direct_title" name="title" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="direct_description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="direct_description" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="direct_category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                            <select class="form-select" id="direct_category" name="category" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="moment">–ú–æ–º–µ–Ω—Ç –∏–∑ –∫–∏–Ω–æ</option>
                                <option value="trailer">–¢—Ä–µ–π–ª–µ—Ä</option>
                                <option value="news">–ù–æ–≤–æ—Å—Ç—å</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="direct-submit-btn">
                            <span id="direct-btn-text">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</span>
                            <span id="direct-loading" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                        <button type="reset" class="btn btn-secondary ms-2">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </form>
                    
                    <div id="direct-result" class="mt-3 d-none">
                        <div class="alert alert-success" role="alert">
                            <h5>‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!</h5>
                            <p id="direct-result-message"></p>
                            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
                            <a href="/admin/content" class="btn btn-sm btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É</a>
                        </div>
                    </div>
                    
                    <div id="direct-error" class="mt-3 d-none">
                        <div class="alert alert-danger" role="alert">
                            <h5>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h5>
                            <p id="direct-error-message"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ -->
        <div class="tab-pane fade" id="link" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üîó –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ –ø–æ —Å—Å—ã–ª–∫–µ</h5>
                    <p class="card-text text-muted">
                        –î–æ–±–∞–≤—å—Ç–µ –≤–∏–¥–µ–æ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ –ø–æ—Å—Ç –≤ Telegram –∏–ª–∏ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ –Ω–∞ –≤–∏–¥–µ–æ.
                    </p>
                    
                    <form id="link-add-form">
                        <div class="mb-3">
                            <label for="link_title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" class="form-control" id="link_title" name="title" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="link_description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="link_description" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="link_category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                            <select class="form-select" id="link_category" name="category" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="moment">–ú–æ–º–µ–Ω—Ç –∏–∑ –∫–∏–Ω–æ</option>
                                <option value="trailer">–¢—Ä–µ–π–ª–µ—Ä</option>
                                <option value="news">–ù–æ–≤–æ—Å—Ç—å</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="post_link" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç –≤ Telegram *</label>
                            <input type="url" class="form-control" id="post_link" name="post_link" placeholder="https://t.me/yourchannel/123" required>
                            <div class="form-text">–ü—Ä–∏–º–µ—Ä: https://t.me/kinofilmuni/12</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="link-submit-btn">
                            <span id="link-btn-text">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ</span>
                            <span id="link-loading" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                        <button type="reset" class="btn btn-secondary ms-2">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </form>
                    
                    <div id="link-result" class="mt-3 d-none">
                        <div class="alert alert-success" role="alert">
                            <h5>‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!</h5>
                            <p id="link-result-message"></p>
                            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
                            <a href="/admin/content" class="btn btn-sm btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É</a>
                        </div>
                    </div>
                    
                    <div id="link-error" class="mt-3 d-none">
                        <div class="alert alert-danger" role="alert">
                            <h5>‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</h5>
                            <p id="link-error-message"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
document.getElementById('direct-upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('direct-submit-btn');
    const btnText = document.getElementById('direct-btn-text');
    const loadingSpinner = document.getElementById('direct-loading');
    const resultDiv = document.getElementById('direct-result');
    const errorDiv = document.getElementById('direct-error');
    const resultMessage = document.getElementById('direct-result-message');
    const errorMessage = document.getElementById('direct-error-message');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    btnText.classList.add('d-none');
    loadingSpinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(this);
        
        const response = await fetch('/api/upload_video', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            resultMessage.textContent = result.message || '–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!';
            resultDiv.classList.remove('d-none');
            errorDiv.classList.add('d-none');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            this.reset();
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            errorMessage.textContent = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            errorDiv.classList.remove('d-none');
            resultDiv.classList.add('d-none');
        }
    } catch (error) {
        errorMessage.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
        errorDiv.classList.remove('d-none');
        resultDiv.classList.add('d-none');
    } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        btnText.classList.remove('d-none');
        loadingSpinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ —Å—Å—ã–ª–∫–µ
document.getElementById('link-add-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('link-submit-btn');
    const btnText = document.getElementById('link-btn-text');
    const loadingSpinner = document.getElementById('link-loading');
    const resultDiv = document.getElementById('link-result');
    const errorDiv = document.getElementById('link-error');
    const resultMessage = document.getElementById('link-result-message');
    const errorMessage = document.getElementById('link-error-message');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    btnText.classList.add('d-none');
    loadingSpinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(this);
        
        const response = await fetch('/admin/add_video_json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: formData.get('title'),
                description: formData.get('description'),
                category: formData.get('category'),
                post_link: formData.get('post_link')
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            resultMessage.textContent = result.message || '–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!';
            resultDiv.classList.remove('d-none');
            errorDiv.classList.add('d-none');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            this.reset();
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            errorMessage.textContent = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            errorDiv.classList.remove('d-none');
            resultDiv.classList.add('d-none');
        }
    } catch (error) {
        errorMessage.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
        errorDiv.classList.remove('d-none');
        resultDiv.classList.add('d-none');
    } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        btnText.classList.remove('d-none');
        loadingSpinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}
