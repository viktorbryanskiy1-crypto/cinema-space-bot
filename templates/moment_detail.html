{% extends "base.html" %}
{% block title %}{{ item.title }} ‚Äî –ú–æ–º–µ–Ω—Ç{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h1>{{ item.title }}</h1>
    {% if item.created_at %}
      <p class="text-muted small">–î–æ–±–∞–≤–ª–µ–Ω–æ: {{ item.created_at }}</p>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col-12 video-wrap" data-moment-id="{{ item.id }}">
    {% if item.video_url %}
      <video controls preload="metadata" style="width:100%; max-height:720px;" data-post-url="{{ item.video_url }}">
        <source src="{{ item.video_url }}" />
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ–≥ video.
      </video>
    {% else %}
      <div class="alert alert-warning">–£ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ.</div>
    {% endif %}
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-8">
    <h5>–û–ø–∏—Å–∞–Ω–∏–µ</h5>
    <p>{{ item.description }}</p>
  </div>
  <div class="col-md-4">
    <h5>–†–µ–∞–∫—Ü–∏–∏</h5>
    <div id="reactions">
      üëç <span id="r-like">{{ reactions['like'] if reactions else 0 }}</span>
      üëé <span id="r-dislike">{{ reactions['dislike'] if reactions else 0 }}</span>
      ‚≠ê <span id="r-star">{{ reactions['star'] if reactions else 0 }}</span>
      üî• <span id="r-fire">{{ reactions['fire'] if reactions else 0 }}</span>
    </div>
    <div class="mt-2">
      <button class="btn btn-sm btn-outline-primary me-1" onclick="sendReaction('like')">üëç</button>
      <button class="btn btn-sm btn-outline-secondary me-1" onclick="sendReaction('dislike')">üëé</button>
      <button class="btn btn-sm btn-outline-warning me-1" onclick="sendReaction('star')">‚≠ê</button>
      <button class="btn btn-sm btn-outline-danger" onclick="sendReaction('fire')">üî•</button>
    </div>
  </div>
</div>

<hr>

<div class="row">
  <div class="col-12">
    <h5>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="comments-count">{{ comments|length if comments else 0 }}</span>)</h5>
    <div id="comments-list">
      {% if comments %}
        {% for c in comments %}
          <div class="comment border rounded p-2">
            <strong>{{ c[0] }}</strong> <small class="text-muted">{{ c[2] }}</small>
            <div>{{ c[1] }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</div>
      {% endif %}
    </div>

    <hr>
    <h6>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h6>
    <form id="comment-form" onsubmit="event.preventDefault(); submitComment();">
      <div class="mb-2">
        <input id="comment-name" class="form-control" placeholder="–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
      </div>
      <div class="mb-2">
        <textarea id="comment-text" class="form-control" rows="3" placeholder="–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"></textarea>
      </div>
      <button class="btn btn-primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
</div>

<script>
const ITEM_TYPE = 'moment';
const ITEM_ID = {{ item.id|tojson }};

async function sendReaction(reaction) {
  try {
    const resp = await fetch('/api/reaction', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({item_type: ITEM_TYPE, item_id: ITEM_ID, reaction: reaction})
    });
    const j = await resp.json();
    if (j.success) {
      // –æ–±–Ω–æ–≤–∏–º —Å—á—ë—Ç—á–∏–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –ø—Ä–æ—â–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É, –Ω–æ –æ–±–Ω–æ–≤–∏–º —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–µ
      // –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤/—Ä–µ–∞–∫—Ü–∏–π ‚Äî –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º
      location.reload();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∞–∫—Ü–∏–∏');
    }
  } catch (e) {
    console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

async function submitComment(){
  const name = document.getElementById('comment-name').value || '–ì–æ—Å—Ç—å';
  const text = document.getElementById('comment-text').value || '';
  if (!text.trim()) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'); return; }
  try {
    const resp = await fetch('/api/comment', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({item_type: ITEM_TYPE, item_id: ITEM_ID, user_name: name, text: text})
    });
    const j = await resp.json();
    if (j.success) {
      // –¥–æ–±–∞–≤–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ
      const now = new Date().toLocaleString();
      const container = document.getElementById('comments-list');
      const div = document.createElement('div');
      div.className = 'comment border rounded p-2';
      div.innerHTML = `<strong>${escapeHtml(name)}</strong> <small class="text-muted">${now}</small><div>${escapeHtml(text)}</div>`;
      container.prepend(div);
      // –æ—á–∏—Å—Ç–∏–º —Ñ–æ—Ä–º—É –∏ —É–≤–µ–ª–∏—á–∏–º —Å—á—ë—Ç—á–∏–∫
      document.getElementById('comment-text').value = '';
      const countEl = document.getElementById('comments-count');
      countEl.textContent = parseInt(countEl.textContent||'0') + 1;
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
    }
  } catch(e){
    console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"'`=\/]/g, function (c) {
    return {
      '&': '&amp;','<': '<','>': '>','"': '&quot;',"'": '&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[c];
  });
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ
document.addEventListener('DOMContentLoaded', function() {
    const video = document.querySelector('video');
    if (video) {
        video.addEventListener('error', async function(e) {
            console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', e);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∏–¥–µ–æ
            const videoWrap = this.closest('.video-wrap');
            if (!videoWrap) return;
            
            // –ü–æ–ª—É—á–∞–µ–º ID –º–æ–º–µ–Ω—Ç–∞
            const momentId = videoWrap.dataset.momentId;
            if (!momentId) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const errorNotice = document.createElement('div');
            errorNotice.className = 'video-error-notice';
            errorNotice.innerHTML = `
                <div style="background: rgba(255, 0, 0, 0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0 0 10px 0;">üîÑ –í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É...</p>
                    <div class="loading-spinner" style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid #00f3ff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            `;
            errorNotice.style.cssText = 'position: relative; z-index: 10;';
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤–∏–¥–µ–æ
            this.parentNode.insertBefore(errorNotice, this);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
                const response = await fetch('/api/refresh_video_url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        moment_id: momentId
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.new_url) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
                    const source = this.querySelector('source');
                    if (source) {
                        source.src = result.new_url;
                    } else {
                        this.src = result.new_url;
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ
                    this.load();
                    
                    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    errorNotice.remove();
                    
                    console.log('–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    errorNotice.innerHTML = `
                        <div style="background: rgba(255, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p style="margin: 0;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ. ${result.error || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'}</p>
                        </div>
                    `;
                }
            } catch (refreshError) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∏–¥–µ–æ:', refreshError);
                errorNotice.innerHTML = `
                    <div style="background: rgba(255, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p style="margin: 0;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                    </div>
                `;
            }
        });
    }
});
</script>
{% endblock %}
