{% extends "base.html" %}
{% block title %}{{ item.title }} ‚Äî –ú–æ–º–µ–Ω—Ç{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h1>{{ item.title }}</h1>
    {% if item.created_at %}
      <p class="text-muted small">–î–æ–±–∞–≤–ª–µ–Ω–æ: {{ item.created_at }}</p>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col-12 video-wrap">
    {% if item.video_url %}
      <video controls preload="metadata" style="width:100%; max-height:720px;">
        <source src="{{ item.video_url }}" />
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ–≥ video.
      </video>
    {% else %}
      <div class="alert alert-warning">–£ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ.</div>
    {% endif %}
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-8">
    <h5>–û–ø–∏—Å–∞–Ω–∏–µ</h5>
    <p>{{ item.description }}</p>
  </div>
  <div class="col-md-4">
    <h5>–†–µ–∞–∫—Ü–∏–∏</h5>
    <div id="reactions">
      üëç <span id="r-like">{{ reactions['like'] if reactions else 0 }}</span>
      üëé <span id="r-dislike">{{ reactions['dislike'] if reactions else 0 }}</span>
      ‚≠ê <span id="r-star">{{ reactions['star'] if reactions else 0 }}</span>
      üî• <span id="r-fire">{{ reactions['fire'] if reactions else 0 }}</span>
    </div>
    <div class="mt-2">
      <button class="btn btn-sm btn-outline-primary me-1" onclick="sendReaction('like')">üëç</button>
      <button class="btn btn-sm btn-outline-secondary me-1" onclick="sendReaction('dislike')">üëé</button>
      <button class="btn btn-sm btn-outline-warning me-1" onclick="sendReaction('star')">‚≠ê</button>
      <button class="btn btn-sm btn-outline-danger" onclick="sendReaction('fire')">üî•</button>
    </div>
  </div>
</div>

<hr>

<div class="row">
  <div class="col-12">
    <h5>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="comments-count">{{ comments|length if comments else 0 }}</span>)</h5>
    <div id="comments-list">
      {% if comments %}
        {% for c in comments %}
          <div class="comment border rounded p-2">
            <strong>{{ c[0] }}</strong> <small class="text-muted">{{ c[2] }}</small>
            <div>{{ c[1] }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</div>
      {% endif %}
    </div>

    <hr>
    <h6>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h6>
    <form id="comment-form" onsubmit="event.preventDefault(); submitComment();">
      <div class="mb-2">
        <input id="comment-name" class="form-control" placeholder="–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
      </div>
      <div class="mb-2">
        <textarea id="comment-text" class="form-control" rows="3" placeholder="–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"></textarea>
      </div>
      <button class="btn btn-primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
</div>

<script>
const ITEM_TYPE = 'moment';
const ITEM_ID = {{ item.id|tojson }};

async function sendReaction(reaction) {
  try {
    const resp = await fetch('/api/reaction', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({item_type: ITEM_TYPE, item_id: ITEM_ID, reaction: reaction})
    });
    const j = await resp.json();
    if (j.success) {
      // –æ–±–Ω–æ–≤–∏–º —Å—á—ë—Ç—á–∏–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –ø—Ä–æ—â–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É, –Ω–æ –æ–±–Ω–æ–≤–∏–º —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–µ
      // –ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤/—Ä–µ–∞–∫—Ü–∏–π ‚Äî –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º
      location.reload();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∞–∫—Ü–∏–∏');
    }
  } catch (e) {
    console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

async function submitComment(){
  const name = document.getElementById('comment-name').value || '–ì–æ—Å—Ç—å';
  const text = document.getElementById('comment-text').value || '';
  if (!text.trim()) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'); return; }
  try {
    const resp = await fetch('/api/comment', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({item_type: ITEM_TYPE, item_id: ITEM_ID, user_name: name, text: text})
    });
    const j = await resp.json();
    if (j.success) {
      // –¥–æ–±–∞–≤–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ
      const now = new Date().toLocaleString();
      const container = document.getElementById('comments-list');
      const div = document.createElement('div');
      div.className = 'comment border rounded p-2';
      div.innerHTML = `<strong>${escapeHtml(name)}</strong> <small class="text-muted">${now}</small><div>${escapeHtml(text)}</div>`;
      container.prepend(div);
      // –æ—á–∏—Å—Ç–∏–º —Ñ–æ—Ä–º—É –∏ —É–≤–µ–ª–∏—á–∏–º —Å—á—ë—Ç—á–∏–∫
      document.getElementById('comment-text').value = '';
      const countEl = document.getElementById('comments-count');
      countEl.textContent = parseInt(countEl.textContent||'0') + 1;
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
    }
  } catch(e){
    console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"'`=\/]/g, function (c) {
    return {
      '&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[c];
  });
}
</script>
{% endblock %}
