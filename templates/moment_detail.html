<!-- templates/moment_detail.html -->
{% extends "base.html" %}
{% block title %}{{ item.title }} ‚Äî –ú–æ–º–µ–Ω—Ç{% endblock %}

{% block content %}
<div class="video-detail-container">
    <!-- –í–∏–¥–µ–æ –ø–ª–µ–µ—Ä -->
    <div class="video-player">
        {% if item.video_url %}
            <video controls autoplay>
                <source src="{{ item.video_url }}" type="video/mp4">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
            </video>
        {% else %}
            <div class="alert alert-warning">–£ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ.</div>
        {% endif %}
    </div>
    
    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
    <h1 class="video-title">{{ item.title }}</h1>
    
    <!-- –†–µ–∞–∫—Ü–∏–∏ -->
    <div class="video-reactions">
        <button class="reaction-btn like" onclick="sendReaction('like')">
            üëç <span id="likes-count">{{ reactions['like'] if reactions else 0 }}</span>
        </button>
        <button class="reaction-btn dislike" onclick="sendReaction('dislike')">
            üëé <span id="dislikes-count">{{ reactions['dislike'] if reactions else 0 }}</span>
        </button>
        <button class="reaction-btn star" onclick="sendReaction('star')">
            ‚≠ê <span id="stars-count">{{ reactions['star'] if reactions else 0 }}</span>
        </button>
        <button class="reaction-btn fire" onclick="sendReaction('fire')">
            üî• <span id="fires-count">{{ reactions['fire'] if reactions else 0 }}</span>
        </button>
    </div>
    
    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
    <div class="video-description">
        {% if item.description %}
            {% if item.description|length > 300 %}
                <div class="description-text" id="description-text">
                    {{ item.description[:300] }}
                    <span id="more-text" style="display:none;">{{ item.description[300:] }}</span>
                    <button onclick="toggleDescription()" id="toggle-desc-btn" class="toggle-description-btn">...–µ—â—ë</button>
                </div>
            {% else %}
                <div class="description-text">{{ item.description }}</div>
            {% endif %}
        {% else %}
            <div class="description-text">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è</div>
        {% endif %}
    </div>
    
    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="comments-section">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
        
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <form id="comment-form" class="comment-form">
            <input type="text" id="comment-name" placeholder="–í–∞—à–µ –∏–º—è" required>
            <textarea id="comment-text" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
        
        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div class="comments-sort">
            <button id="sort-popular" onclick="loadComments('popular')" class="sort-btn active">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
            <button id="sort-latest" onclick="loadComments('latest')" class="sort-btn">–ù–æ–≤—ã–µ</button>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div id="comments-list">
            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <button id="load-more-comments" onclick="loadAllComments()" style="display:none;">
            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        </button>
    </div>
</div>

<script>
const ITEM_TYPE = 'moment';
const ITEM_ID = {{ item.id|tojson }};

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
function toggleDescription() {
    const moreText = document.getElementById('more-text');
    const btn = document.getElementById('toggle-desc-btn');
    
    if (moreText.style.display === 'none') {
        moreText.style.display = 'inline';
        btn.textContent = '—Å–∫—Ä—ã—Ç—å';
    } else {
        moreText.style.display = 'none';
        btn.textContent = '...–µ—â—ë';
    }
}

// –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –≤–∏–¥–µ–æ
async function sendReaction(reaction) {
    try {
        const response = await fetch('/api/reaction', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                item_type: ITEM_TYPE, 
                item_id: ITEM_ID, 
                user_id: 'anonymous', 
                reaction: reaction
            })
        });
        const result = await response.json();
        if (result.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById(`${reaction}s-count`).textContent = 
                (parseInt(document.getElementById(`${reaction}s-count`).textContent) || 0) + 1;
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∞–∫—Ü–∏–∏');
        }
    } catch (e) {
        console.error(e); 
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
document.getElementById('comment-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const name = document.getElementById('comment-name').value || '–ì–æ—Å—Ç—å';
    const text = document.getElementById('comment-text').value || '';
    if (!text.trim()) { 
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'); 
        return; 
    }
    
    try {
        const response = await fetch('/api/comment', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                item_type: ITEM_TYPE, 
                item_id: ITEM_ID, 
                user_name: name, 
                text: text
            })
        });
        const result = await response.json();
        if (result.success) {
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('comment-text').value = '';
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            loadComments('popular');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
        }
    } catch(e){
        console.error(e); 
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
async function loadComments(sortBy = 'popular') {
    try {
        // –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`sort-${sortBy}`).classList.add('active');
        
        const response = await fetch(`/api/comments/${ITEM_TYPE}/${ITEM_ID}?sort=${sortBy}&limit=3`);
        const result = await response.json();
        
        if (result.comments) {
            displayComments(result.comments);
            document.getElementById('load-more-comments').style.display = 
                result.comments.length >= 3 ? 'block' : 'none';
        }
    } catch (e) {
        console.error(e);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
async function loadAllComments() {
    try {
        const response = await fetch(`/api/comments/${ITEM_TYPE}/${ITEM_ID}?sort=popular`);
        const result = await response.json();
        
        if (result.comments) {
            displayComments(result.comments);
            document.getElementById('load-more-comments').style.display = 'none';
        }
    } catch (e) {
        console.error(e);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function displayComments(comments) {
    const container = document.getElementById('comments-list');
    container.innerHTML = '';
    
    if (comments.length === 0) {
        container.innerHTML = '<div class="no-comments">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
        return;
    }
    
    comments.forEach(comment => {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö)
        const commentId = comment.id || Math.random(); // –ó–∞–≥–ª—É—à–∫–∞ –µ—Å–ª–∏ ID –Ω–µ—Ç
        
        const commentEl = document.createElement('div');
        commentEl.className = 'comment';
        commentEl.innerHTML = `
            <div class="comment-header">
                <strong class="comment-author">${comment[0] || '–ì–æ—Å—Ç—å'}</strong>
                <span class="comment-date">${formatDate(comment[2])}</span>
            </div>
            <div class="comment-text">${comment[1] || ''}</div>
            <div class="comment-reactions">
                <button class="comment-reaction-btn like" onclick="sendCommentReaction(${commentId}, 'like')">
                    üëç <span>${comment.likes || 0}</span>
                </button>
                <button class="comment-reaction-btn dislike" onclick="sendCommentReaction(${commentId}, 'dislike')">
                    üëé <span>${comment.dislikes || 0}</span>
                </button>
            </div>
        `;
        container.appendChild(commentEl);
    });
}

// –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–∑–∞–≥–ª—É—à–∫–∞, –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API)
async function sendCommentReaction(commentId, reaction) {
    alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
    // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadComments('popular');
});
</script>

<style>
.video-detail-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.video-player {
    width: 100%;
    margin-bottom: 20px;
}

.video-player video {
    width: 100%;
    border-radius: 8px;
}

.video-title {
    font-size: 24px;
    margin: 20px 0 15px 0;
    font-weight: bold;
}

.video-reactions {
    display: flex;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.reaction-btn {
    background: #f0f0f0;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
}

.reaction-btn:hover {
    background: #e0e0e0;
    transform: translateY(-2px);
}

.video-description {
    margin: 25px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
}

.description-text {
    line-height: 1.6;
    font-size: 16px;
}

.toggle-description-btn {
    background: none;
    border: none;
    color: #007bff;
    cursor: pointer;
    font-size: 16px;
    margin-left: 5px;
}

.comments-section {
    margin-top: 40px;
}

.comment-form {
    margin-bottom: 30px;
}

.comment-form input,
.comment-form textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
}

.comment-form textarea {
    height: 80px;
    resize: vertical;
}

.comment-form button {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.comments-sort {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.sort-btn {
    padding: 8px 15px;
    background: #e9ecef;
    border: none;
    border-radius: 20px;
    cursor: pointer;
}

.sort-btn.active {
    background: #007bff;
    color: white;
}

.comment {
    padding: 15px;
    border-bottom: 1px solid #eee;
    margin-bottom: 15px;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.comment-author {
    font-weight: bold;
}

.comment-date {
    color: #6c757d;
    font-size: 14px;
}

.comment-text {
    margin-bottom: 15px;
    line-height: 1.5;
}

.comment-reactions {
    display: flex;
    gap: 15px;
}

.comment-reaction-btn {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    color: #6c757d;
    font-size: 14px;
}

.comment-reaction-btn:hover {
    color: #007bff;
}

.no-comments {
    text-align: center;
    color: #6c757d;
    padding: 30px;
}
</style>
{% endblock %}
